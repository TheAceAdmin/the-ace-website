(()=>{var d=null,s="https://script.google.com/macros/s/AKfycbwfryZ3wOD4ZKA9JSS2_e5BlsykcVk2WTi74v3Uyl4o_UVKyhdGQAOqrVJzcQDFoA9k/exec";async function b(e,t){try{if(!s||s==="YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE")throw new Error("Google Script URL not configured");console.log("Searching for properties: Block "+e+", Door "+t);let o=await fetch(s,{method:"POST",mode:"cors",cache:"no-store",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"searchProperties",block:e,doorNumber:t})});if(!o.ok)throw new Error(`Failed to search properties: ${o.status} ${o.statusText}`);let n=await o.json();if(n.status==="error")throw new Error(n.data?.error||"Error searching properties");if(n.status==="success"&&Array.isArray(n.data))return console.log(`Found ${n.data.length} matching properties`),n.data;throw new Error("Invalid data format received from Google Script")}catch(o){throw console.error("Error searching properties:",o),o}}async function p(e){d=e;let t=await y(e);document.getElementById("snoResult").textContent=e.sNo,document.getElementById("billNumberResult").textContent=e.billNumber,document.getElementById("ownerNameResult").textContent=e.ownerName,document.getElementById("propertyAddressResult").textContent=e.propertyAddress,document.getElementById("mobileNoResult").textContent=e.mobileNo,document.getElementById("propertyTypeResult").textContent=e.propertyType,document.getElementById("propertyUsageResult").textContent=e.propertyUsage,document.getElementById("currentTaxResult").textContent=m(e.currentTax),document.getElementById("arrearTaxResult").textContent=m(e.arrearTaxDue);let o=t?0:e.balanceAmount;document.getElementById("balanceAmountResult").textContent=m(o),E(e.billNumber),document.getElementById("results").style.display="block",document.getElementById("results").scrollIntoView({behavior:"smooth",block:"nearest"});let n=document.getElementById("markPaidButton");n.style.display="block",n.disabled=!0,n.textContent="Checking status...",n.style.backgroundColor="#6c757d",g(e).then(()=>{console.log("Payment status checked")})}function m(e){return!e||e===""?"\u20B90":"\u20B9"+(parseFloat(e.toString().replace(/,/g,""))||0).toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}function c(e){let t=document.getElementById("errorMessage");t.innerHTML=e,t.style.display="block",document.getElementById("successMessage").style.display="none"}function f(e){let t=document.getElementById("successMessage");t.textContent=e,t.style.display="block",document.getElementById("errorMessage").style.display="none"}function P(){document.getElementById("errorMessage").style.display="none",document.getElementById("successMessage").style.display="none"}function E(e){let t=e.split("-");if(t.length>=3){let o=t[2],n=t[3]||"000",a=t[0]||"14",r=t[1]||"184",l=`https://erp.chennaicorporation.gov.in/ptis/citizensearch/searchPropByBillNumber!search.action?isNew=N&zoneNo=${a}&wardNo=${r}&propertyId=${o}&subNo=${n}&newzoneNo=&newwardNo=&newbillNo=&flag=N&search1=Search&collectionType=online`;document.getElementById("paymentLink").href=l}}async function B(e,t=0){if(!s||s==="YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE")return console.log("Google Script URL not configured"),null;console.log("Attempting to check payment status from sheet (may fail due to CORS)...");try{let o=JSON.stringify({action:"checkStatus",billNumber:e});console.log("Sending POST request to check status for:",e);let n=await fetch(s,{method:"POST",mode:"cors",cache:"no-store",headers:{"Content-Type":"text/plain;charset=utf-8"},body:o});if(n.ok){let a=await n.json();console.log("Payment status response received:",a);let l=((a.data||a).status||"").toString().trim(),i=l.toLowerCase()==="paid";return console.log("Status from sheet:",l,"Is Paid:",i),i}else return console.warn("Response not OK:",n.status,n.statusText),null}catch(o){return o.message&&(o.message.includes("CORS")||o.message.includes("Access-Control")||o.message.includes("Failed to fetch"))?(console.warn("CORS error - cannot check sheet status. This is expected. Using balance amount check only."),null):(console.error("Error checking payment status:",o),null)}}async function y(e){console.log("Checking if already paid for property:",e.billNumber);let t=parseFloat((e.balanceAmount||"0").toString().replace(/,/g,""))||0;if(console.log("Balance amount:",t),t===0)return console.log("Property is paid (balance is 0)"),!0;try{let o=await B(e.billNumber);if(console.log("Is paid in sheet:",o),o===!0)return console.log("Property is paid (status in sheet is Paid)"),!0}catch(o){console.warn("Could not check sheet status (CORS or other error):",o.message),console.log("Falling back to balance amount check only")}return console.log("Property is not paid"),!1}async function g(e){let t=document.getElementById("markPaidButton");if(t.textContent==="Already Paid"&&t.disabled)return await y(e),void 0;console.log("Updating button state for property:",e.billNumber);let o=await y(e);console.log("Final isAlreadyPaid result:",o),o?(console.log("Setting button to Already Paid"),t.disabled=!0,t.textContent="Already Paid",t.style.backgroundColor="#6c757d",t.style.cursor="not-allowed"):(console.log("Setting button to Mark as Paid"),t.disabled=!1,t.textContent="Mark as Paid",t.style.backgroundColor="#28a745",t.style.cursor="pointer")}async function k(){if(!d){c("No property selected");return}if(!s||s==="YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE"){c("Google Apps Script URL not configured. Please contact administrator.");return}let e=document.getElementById("markPaidButton");e.disabled=!0,e.textContent="Updating...";try{let t=await fetch(s,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify({action:"markPaid",billNumber:d.billNumber})});f("Payment status updated successfully!"),e.disabled=!0,e.textContent="Already Paid",e.style.backgroundColor="#6c757d",e.style.cursor="not-allowed",setTimeout(async()=>{await g(d)},2e3)}catch(t){console.error("Error marking as paid:",t),c("Failed to update payment status. Please try again or contact administrator."),e.disabled=!1,e.textContent="Mark as Paid",e.style.backgroundColor="#28a745",e.style.cursor="pointer"}}document.getElementById("searchForm").addEventListener("submit",async function(e){e.preventDefault(),P();let t=document.getElementById("block").value.trim().toUpperCase(),o=document.getElementById("doorNumber").value.trim();if(!t||!o){c("Please enter both Block and Door Number");return}let n=document.querySelector(".search-button"),a=n.textContent;n.disabled=!0,n.textContent="Searching...",document.getElementById("results").style.display="none",document.getElementById("propertySelection").style.display="none";try{let r=await b(t,o);if(n.disabled=!1,n.textContent=a,r.length===0){c('Property not found. Please check your Block and Door Number. If your property is not listed here, please visit the <a href="https://chennaicorporation.gov.in/gcc/online-payment/property-tax/property-tax-online-payment/" target="_blank" style="color: #000080; text-decoration: underline;">Greater Chennai Corporation website</a> to check your property tax details and make payment.');return}if(r.length>1){let l=document.getElementById("propertySelect");l.innerHTML='<option value="">-- Select a property --</option>',r.forEach((i,h)=>{let u=document.createElement("option");u.value=h,u.textContent=`${i.ownerName} - ${i.propertyAddress} (Bill: ${i.billNumber})`,l.appendChild(u)}),document.getElementById("propertySelection").style.display="block",document.getElementById("propertySelection").scrollIntoView({behavior:"smooth",block:"nearest"}),window.selectedProperties=r}else document.getElementById("propertySelection").style.display="none",p(r[0])}catch(r){n.disabled=!1,n.textContent=a,console.error("Search error:",r),c("Failed to search for properties. Please try again or contact the administrator if the problem persists.")}});document.getElementById("markPaidButton").addEventListener("click",k);document.getElementById("selectPropertyButton").addEventListener("click",function(){let t=document.getElementById("propertySelect").value;if(t===""||!window.selectedProperties){c("Please select a property from the list");return}let o=window.selectedProperties[parseInt(t)];o&&(document.getElementById("propertySelection").style.display="none",p(o))});})();
